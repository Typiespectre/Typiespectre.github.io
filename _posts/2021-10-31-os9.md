---
title: "OSTEP - 가상화: 메모리 관리 API"
lang: "ko"
layout: post
date: 2021-10-31 15:20:54 +0900
categories: [os]
tags: [os]
---
이번 장에서는 C언어의 메모리 관리 API에 대해서 간단하게 배운다. 메모리 관리 API를 이용하여 메모리의 사용자 주소 공간을 할당하거나 해제할 수 있다. 이러한 할당과 해제에 필요한 API는 무엇이고, 어떠한 실수가 발생할 수 있을까?

우선 C프로그램이 실행되면 두 가지 유형의 메모리 공간이 생성된다. 하나는 스택(stack)메모리라고 불리며, 할당과 반환은 컴파일러에 의해 _암묵적으로_ 이루어지기에, **자동(automatic)** 메모리라고 불리기도 한다. C프로그램에서 스택에 메모리를 선언하는 방식은 다음과 같다:
```c
// func()라는 함수에 x라 불리는 정수를 위한 공간이 필요한 경우
void func() {
    int x; // 스택에 int 형을 선언
    ...
}
```
함수가 호출되면 컴파일러는 스택에 공간을 확보한다. 함수에서 리턴하면 컴파일러는 사용자를 대신해 메모리를 반환한다.

다른 하나는 힙(heap) 메모리라고 불리며, 모든 할당과 반환이 사용자에 의해 명시적으로 처리된다. 위의 스택 메모리는 컴파일러가 자동으로 메모리를 할당하고 반환하기에, 힙 메모리를 이용하면 원하는 값을 원하는 시간만큼 유지할 수 있다. 이러한 권한만큼 다양한 오류가 생성되는 원인이기도 하다. C프로그램에서 힙에 할당하는 방식은 다음과 같다:
```c
void func() {
    int *x = (int *) malloc(sizeof(int));
    ...
}
```
위의 코드에서 짚고 넘어가야 할 점들이 있다. 위의 코드에서는 스택과 힙 할당이 모두 발생하는데, 먼저 컴파일러가 포인터 변수의 선언(`int *x`)를 만나 정수 포인터를 위한 공간을 할당해야 함을 알아차리게 된다. 그리고 프로그램이 `malloc()`을 호출하여 정수를 위한 공간을 힙으로부터 요구한다. 이후 `malloc()`은 그 정수의 주소를 반환한다(만약 반환에 실패하면 NULL을 반환한다). 반환된 주소는 스택에 저장되어 프로그램에 의해 사용된다.

