---
title: "OSTEP - 가상화: 메모리 크기의 극복: 매커니즘"
lang: "ko"
layout: post
date: 2022-05-11 22:36:23 +0900
categories: [os]
tags: [os]
---

프로세스가 큰 주소 공간을 가진 것처럼 행동하려면, 운영체제는 주소 공간 중 현재는 크게 필요하지 않은 일부를 물리 메모리에서 따로 떼어내 보관해 둘 공간이 필요할 것이다. 또한 멀티프로그래밍(동시에 여러 프로그램들을 실행시키는 시스템)과 사용 편의성 등의 이유로, 실제 물리 메모리보다 더 많은 용량의 메모리가 필요하게 되었다. 이것이 현대 가상 메모리(Virtual Memory)의 역할이며, 현대 시스템에서는 보통 **하드 디스크 드라이브**가 그 역할을 담당한다. 그렇다면 *운영체제는 어떻게 크고 느린 장치를 사용하면서, 마치 커다란 가상 주소 공간이 있는 것처럼 할 수 있을까?* 먼저, (하드 디스크 드라이브와 같은) **스왑 공간(swap space)**이 추가되면, 운영체제는 프로세스로 하여금 큰 가상 메모리가 있는 것 같은 환상을 줄 수 있다.

## 스왑 공간

스왑 공간은 페이지들을 저장할 수 있는 일정 공간을 의미한다. 메모리 페이지를 읽어서 디스크와 같은 공간에 쓰는 것을 *스왑 아웃(swap out)*이라고 하며, 그러한 공간에서 페이지를 읽어 메모리에 탑재하는 것을 *스왑 인(swap in)*이라고 한다. 따라서 운영체제는 스왑 공간에 있는 모든 페이지들의 **디스크 주소**를 기억해야 한다. 스왑 공간을 이용하면, 프로세스에게 물리 메모리 공간보다 더 많은 공간이 존재하는 것처럼 보이게 할 수 있다.

## Present Bit

디스크와 같은 공간에 스왑을 하기 위해선, 페이지 스왑을 위한 기능의 구현이 필요하다(여기선 하드웨어 기반의 TLB를 사용하는 시스템을 가정한다).

1. 하드웨어는 먼저 가상 주소에서 VPN을 추출한 후, TLB에 해당 정보가 있는지 검사한다.
	- 만약 **TLB 히트**가 되면, TLB에서 물리 주소를 얻은 후 메모리로 가져온다.
	- 만약 **TLB 미스**(TLB에서 VPN을 찾을 수 없는 경우)가 되면:
		1) 하드웨어는 **페이지 테이블 베이스 레지스터**를 사용하여, 페이지 테이블(프로세스의 페이지 정보를 담고 있는 테이블. 하나의 프로세스는 하나의 페이지 테이블을 가진다.)의 메모리 주소를 파악하고,
		2) VPN을 인덱스로 하여 원하는 **페이지 테이블 항목(PTE)**를 추출한다.
